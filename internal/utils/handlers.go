package utils

import (
	"bytes"
	"fmt"
	"log"
	"os"
	"os/exec"
	"strings"

	maxbot "github.com/max-messenger/max-bot-api-client-go"
	"github.com/max-messenger/max-bot-api-client-go/schemes"
)

// HandleUpdate –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
func HandleUpdate(api *maxbot.Api, update interface{}) error {
	switch upd := update.(type) {
	case *schemes.MessageCreatedUpdate:
		// –ó–ê–ü–£–°–ö–ê–ï–ú –≤ –≥–æ—Ä—É—Ç–∏–Ω–µ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!
		go func() {
			if err := HandleMessage(api, upd); err != nil {
				log.Printf("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: %v", err)
			}
		}()
	default:
		log.Printf("–ü–æ–ª—É—á–µ–Ω –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: %T", update)
	}
	return nil
}

// HandleMessage –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
func HandleMessage(api *maxbot.Api, update *schemes.MessageCreatedUpdate) error {
	log.Printf("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç %d: %s",
		update.Message.Sender.UserId, update.Message.Body.Text)

	// –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
	msgCtx, cancel := CreateMessageContext()
	defer cancel()

	// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
	response, err := GenerateResponse(update.Message.Body.Text)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: %w", err)
	}

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
	_, err = api.Messages.Send(
		msgCtx,
		maxbot.NewMessage().
			SetChat(update.Message.Recipient.ChatId).
			SetText(response),
	)

	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: %w", err)
	}

	log.Printf("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %d", update.Message.Sender.UserId)
	return nil
}

// GenerateResponse –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// GenerateResponse –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func GenerateResponse(userMessage string) (string, error) {
	if userMessage == "" {
		return "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—å–≥–æ—Ç –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤. –ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ, –∫–∞–∫–∏–µ –ª—å–≥–æ—Ç—ã –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ø–∞—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ 2 –≥—Ä—É–ø–ø—ã' –∏–ª–∏ '–ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤'.", nil
	}

	// –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
	userMessage = strings.TrimSpace(userMessage)

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Go (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
	switch strings.ToLower(userMessage) {
	case "/start", "start", "–Ω–∞—á–∞—Ç—å":
		return getWelcomeMessage(), nil
	case "/help", "help", "–ø–æ–º–æ—â—å":
		return getHelpMessage(), nil
	case "/stats", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
		return getStatsMessage(), nil
	}

	// –í—ã–∑–æ–≤ Python-—Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
	response, err := callPythonScript(userMessage)
	if err != nil {
		log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Python-—Å–∫—Ä–∏–ø—Ç–∞: %v", err)
		return getFallbackResponse(userMessage), nil
	}

	return response, nil
}

// callPythonScript –≤—ã–∑—ã–≤–∞–µ—Ç Python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—å–≥–æ—Ç
// callPythonScript –≤—ã–∑—ã–≤–∞–µ—Ç Python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—å–≥–æ—Ç
func callPythonScript(query string) (string, error) {
	log.Printf("–í—ã–∑–æ–≤ Python-—Å–∫—Ä–∏–ø—Ç–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º: '%s'", query)

	// –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–∞–ø–∫—É neuro –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
	scriptPath := "neuro/main.py"

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
	if _, err := os.Stat(scriptPath); os.IsNotExist(err) {
		// –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏
		possiblePaths := []string{
			"neuro/main.py",
			"../neuro/main.py",
			"../../neuro/main.py",
			"./neuro/main.py",
		}

		for _, path := range possiblePaths {
			if _, err := os.Stat(path); err == nil {
				scriptPath = path
				break
			}
		}
	}

	log.Printf("–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É: %s", scriptPath)
	cmd := exec.Command("python3", scriptPath, query)

	var stdout, stderr bytes.Buffer
	cmd.Stdout = &stdout
	cmd.Stderr = &stderr

	err := cmd.Run()

	log.Printf("STDOUT: %s", stdout.String())
	log.Printf("STDERR: %s", stderr.String())

	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞: %w, stderr: %s", err, stderr.String())
	}

	return strings.TrimSpace(stdout.String()), nil
}

// getWelcomeMessage –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
func getWelcomeMessage() string {
	return `üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –ø–æ–∏—Å–∫–∞ –ª—å–≥–æ—Ç –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤!

–Ø –ø–æ–º–æ–≥—É –≤–∞–º –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª—å–≥–æ—Ç–∞—Ö, –ø–æ—Å–æ–±–∏—è—Ö –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ä–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏.

üéØ *–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª–æ–≤–∞:*
‚Ä¢ *–°—Ñ–µ—Ä–∞:* "–ø–∞—Ä–∫–æ–≤–∫–∞", "–ª–µ–∫–∞—Ä—Å—Ç–≤–∞", "–ø—Ä–æ–µ–∑–¥", "–ñ–ö–£", "–Ω–∞–ª–æ–≥–∏"
‚Ä¢ *–ì—Ä—É–ø–ø–∞:* "1 –≥—Ä—É–ø–ø–∞", "2 –≥—Ä—É–ø–ø–∞", "3 –≥—Ä—É–ø–ø–∞", "—Ä–µ–±–µ–Ω–æ–∫-–∏–Ω–≤–∞–ª–∏–¥"
‚Ä¢ *–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å:* "–ø–∞—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ 2 –≥—Ä—É–ø–ø—ã"

üí° *–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:*
"–ö–∞–∫–∏–µ –ª—å–≥–æ—Ç—ã –ø–æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞–º –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞ 2 –≥—Ä—É–ø–ø—ã?"
"–ü–∞—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ –≤ –ú–æ—Å–∫–≤–µ"
"–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –ñ–ö–£ –¥–ª—è —Å–µ–º–µ–π —Å –¥–µ—Ç—å–º–∏-–∏–Ω–≤–∞–ª–∏–¥–∞–º–∏"

üìù –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –∏ —è –Ω–∞–π–¥—É –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ª—å–≥–æ—Ç—ã!`
}

// getHelpMessage –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
func getHelpMessage() string {
	return `‚ùì *–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:*

–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

‚Ä¢ *–ü–æ —Å—Ñ–µ—Ä–µ:* "–ø–∞—Ä–∫–æ–≤–∫–∞", "–ª–µ–∫–∞—Ä—Å—Ç–≤–∞", "–ø—Ä–æ–µ–∑–¥", "–ñ–ö–£"
‚Ä¢ *–ü–æ –≥—Ä—É–ø–ø–µ:* "–ª—å–≥–æ—Ç—ã –¥–ª—è 1 –≥—Ä—É–ø–ø—ã", "–∏–Ω–≤–∞–ª–∏–¥ 2 –≥—Ä—É–ø–ø—ã"  
‚Ä¢ *–î–ª—è –¥–µ—Ç–µ–π:* "—Ä–µ–±–µ–Ω–æ–∫-–∏–Ω–≤–∞–ª–∏–¥", "–¥–µ—Ç—Å–∫–∏–π —Å–∞–¥"
‚Ä¢ *–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:* "–ø–∞—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ 2 –≥—Ä—É–ø–ø—ã"

*–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:*
"–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤"
"–ü–∞—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ 1 –≥—Ä—É–ø–ø—ã" 
"–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –ñ–ö–£ –¥–ª—è —Å–µ–º–µ–π —Å –¥–µ—Ç—å–º–∏-–∏–Ω–≤–∞–ª–∏–¥–∞–º–∏"
"–ù–∞–ª–æ–≥–æ–≤—ã–µ –ª—å–≥–æ—Ç—ã –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ 3 –≥—Ä—É–ø–ø—ã"

üìä *–ö–æ–º–∞–Ω–¥—ã:*
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/help - –ø–æ–º–æ—â—å  
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

üí° *–°–æ–≤–µ—Ç:* —á–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ –∑–∞–ø—Ä–æ—Å, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –±—É–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!`
}

// getStatsMessage –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
func getStatsMessage() string {
	return `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*

‚Ä¢ –í—Å–µ–≥–æ –ª—å–≥–æ—Ç –≤ –±–∞–∑–µ: 50
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
‚Ä¢ –í–∞—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.`
}

// getFallbackResponse –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
func getFallbackResponse(query string) string {
	return fmt.Sprintf(`‚ö†Ô∏è –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è —Å–µ—Ä–≤–∏—Å –ø–æ–∏—Å–∫–∞ –ª—å–≥–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

–í–∞—à –∑–∞–ø—Ä–æ—Å: "%s"

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:
‚Ä¢ –ø–∞—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤
‚Ä¢ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–æ–≤ 2 –≥—Ä—É–ø–ø—ã  
‚Ä¢ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –ñ–ö–£
‚Ä¢ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –ª—å–≥–æ—Ç—ã

–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞.`, query)
}
